# 跨域

> 参考链接：https://developer.mozilla.org/zh-CN/docs/Web/Security/Same-origin_policy

## 什么是跨域？

> 跨域是浏览器的一种同源安全策略。

### 跨域的条件： 
```
1. 域名不同（主域名\子域名的不同）；
2. 协议不同：http和https协议不同跨域；
3. 端口跨域（同协议同域名不同端口）；

注：IE浏览器在同源上面的不同点：
a、授信范围，两个互相之间高度互信的域名，如公司域名，不遵守同源策略限制；
b、端口：IE未将端口号加入到同源策略的组成部分之中。
```

### 修改源
```
可以使用document.domain实现
```


## 怎么解决跨域？
### Vue解决跨域
#### 开发环境
```
配置代理：
相对路径：src/config/index.js文件里面：
  // 代理配置表，在这里配置特定的请求代理到对应的API接口
  // 例如将localhost:8080/api/xxx 代理到 'www.example.com/api/xxx'
    
  proxyTable: {
    '/api': {
      target: 'http://xxxxx.com' // 接口域名
      // sercure: false, //如果是https接口，需要配置这个参数
      changeOrigin: true, // 是否修改源域名，默认值为true
      bypass: function(req, res, proxyOptions){
        req.headers.referer = 'https/c.y.qq.com'
        req.headers.host = 'c.y.qq.com'
      }
      //如果接口跨域，需要进行这个参数配置
      pathRewrite: {
        '^/api': ''
      }
    }
  }

接口地址原本是 /save/index，但是为了匹配代理地址，在前面加一个 /api,  因此接口地址需要写成这样的即可生效 /api/save/index。

注意： '/api' 为匹配项，target 为被请求的地址，因为在 ajax 的 url 中加了前缀 '/api'，而原本的接口是没有这个前缀的，所以需要通过 pathRewrite 来重写地址，将前缀 '/api' 转为 '/'。如果本身的接口地址就有 '/api' 这种通用前缀，就可以把 pathRewrite 删掉。

参考链接：
  https://blog.csdn.net/zyx1303031629/article/details/79540859
```


#### 生产环境 
##### 可以使用niginx反向代理解决跨域问题 —— 代理转发 


### react+umi项目解决跨域问题 + SCP安全机制问题

#### 开发环境

##### 解决跨域问题与vue类似，设置代理服务器配置即可。

在umi项目的config/config.js文件中配置代理服务器，或者根据项目的不同，找到.umirc.ts文件，配置代理服务器。
umi的defineConfig函数参数有一个proxy属性，这个属性是用来配置代理的。

```ts
// 代理配置表，在这里配置特定的请求代理到对应的API接口
// 例如将localhost:8080/api/xxx 代理到 'www.example.com/api/xxx'
proxy: {
  '/api': {
    target: 'http://xxxxx.com' // 目标的域名和协议
    // sercure: false, //如果是https接口，需要配置这个参数
    changeOrigin: true, // 是否修改源域名，默认值为true
    //如果接口跨域，需要进行这个参数配置
    pathRewrite: {
      '^/api': '' // 重写路径，将/api前缀去掉，用target目标地址替换掉/api前缀的相关接口
    },
  },
  '/help-center': {
    target: 'https://a.xxx.com/help-center/',
    changeOrigin: true,
    pathRewrite: {
      '^/help-center': ''
    }
  }
}
```

##### 遇到的问题

<b>假设我当前有一个iframe，我使用iframe去加载一个第三方的页面，除了会出现跨域问题，还出现了SCP安全机制问题；其中还有目标地址出现301/302被重定向了的问题，我该怎么解决？</b>

###### <span style="color:red;">假如目标地址上面出现了301/302重定向，会出现页面访问不了空白的情况。</span>

==这是因为浏览器会自动跳转，但是跳转的地址是跨域的，浏览器不允许跨域跳转==。

###### 解决301/302重定向问题，在代理服务器上解决
```ts
// 增加代理配置处理301、302重定向问题
'/help-center': {
  target: 'https://a.xxx.com/help-center/',
  changeOrigin: true,
  secure: false,
  headers: {
    Connection: 'keep-alive',
    referer: 'https://a.xxx.com/help-center/',
    host: 'a.xxx.com'
  },
  pathRewrite: {
    '^/help-center': ''
  },
  // 关键配置
  onProxyRes: function(proxyRes, req, res) {
    if (proxyRes.statusCode === 301 || proxyRes.statusCode === 302) {
      const originalLocation = proxyRes.headers['location'];
      if (originalLocation && originalLocation.includes('https://a.xxx.com')) {
        // rewrite location header
        const path = originalLocation.replace('https://a.xxx.com', '');
        proxyRes.headers['location'] = `/help-center${path}`;
        // rewritten 302 code
        proxyRes.statusCode = 302;
        
        console.log(`Redirect rewritten: ${originalLocation} -> ${proxyRes.headers['location']}`);
      }
    }
  }
}
```

重启项目，即可生效。再次查看iframe加载是否正常，301/302问题得到解决。

###### 解决SCP安全机制问题

另外一种处理跨域的方式是直接通过后端处理scp添加白名单的方式处理跨域问题。

TODO: 待验证，未实践
```
// 解决SCP安全机制问题
onProxyRes: function(proxyRes, req, res) {
  proxyRes.headers['access-control-allow-origin'] = '*'
}
```
























